<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xotkari - Latest Articles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .article-card {
      height: 100%;
      transition: transform 0.2s;
    }
    .article-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .article-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      display: block;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .article-source {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .article-date {
      font-size: 0.85rem;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="mb-4">
      <h1 class="text-center mb-4">Xotkari - Latest Articles</h1>
      <p class="text-muted text-center">Stay updated with the latest news and articles</p>
    </header>

    <div id="articles-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>

    <div id="loading" class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading more articles...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let isLoading = false;
    let hasMore = true;
    let currentDayOffset = 0;

    const articlesGrid = document.getElementById('articles-grid');
    const loadingElement = document.getElementById('loading');

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getDateForOffset(offset) {
      const date = new Date();
      date.setDate(date.getDate() - offset);
      return date;
    }

    function timeAgo(published) {
      try {
        const pub = new Date(published);
        const now = new Date();
        const diffMs = now - pub;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHr = Math.floor(diffMin / 60);
        if (diffHr < 8) {
          if (diffHr >= 1) return `${diffHr}h ago`;
          if (diffMin >= 1) return `${diffMin}m ago`;
          return `${diffSec}s ago`;
        }
        return pub.toLocaleString([], {hour: '2-digit', minute:'2-digit'});
      } catch {
        return '';
      }
    }

    async function fetchArticlesForDate(date) {
      const dateStr = formatDate(date);
      const [year, month, day] = dateStr.split('-');
      try {
        const url = `https://raw.githubusercontent.com/informeto/xotkari-public-data/refs/heads/daily/${dateStr}/${year}/${month}/${day}/_meta.json`;
        const response = await axios.get(url, { validateStatus: s => s === 200 || s === 404 });
        if (response.status === 404 || !response.data) return [];
        const articles = Array.isArray(response.data?.recent)
          ? response.data.recent.map(a => ({...a, published_at: a.published_at || dateStr}))
          : [];
        return articles;
      } catch {
        return [];
      }
    }

    async function loadArticleDetails(article, cardElement) {
      try {
        const dateStr = article.published_at ? article.published_at.split('T')[0] : formatDate(new Date());
        const [year, month, day] = dateStr.split('-');
        const subdir = article.id.substring(0, 2);
        const storeUrl = `https://raw.githubusercontent.com/informeto/xotkari-public-data/refs/heads/daily/${year}-${month}-${day}/_store/${subdir}/${article.id}.json`;

        const resp = await fetch(storeUrl);
        if (!resp.ok) throw new Error('Failed fetch');
        const details = await resp.json();

        let og = {};
        const ogProps = details.metadata?.raw?.opengraph?.[0]?.properties || [];
        ogProps.forEach(([k, v]) => { og[k] = v; });

        const title = og['og:title'] || details.title || '';
        const description = og['og:description'] || details.description || details.summary || '';
        const image = og['og:image'] || (details.images?.[0] || '');
        const source = details.source || details.domain || 'Unknown';
        const url = og['og:url'] || details.url || '#';
        const published = details.published_at || article.published_at;

        if (cardElement) {
          const imgEl = cardElement.querySelector('.article-image');
          if (imgEl && image) {
            imgEl.src = image;
            imgEl.classList.remove('d-none');
          }
          const titleEl = cardElement.querySelector('.card-title');
          if (titleEl) titleEl.textContent = title;
          const contentEl = cardElement.querySelector('.article-content');
          if (contentEl) contentEl.textContent = description;
          const sourceEl = cardElement.querySelector('.article-source');
          if (sourceEl) sourceEl.textContent = source;
          const dateEl = cardElement.querySelector('.article-date');
          if (dateEl && published) dateEl.textContent = timeAgo(published);
          const link = cardElement.querySelector('a');
          if (link) link.href = url;
        }
      } catch (err) {
        console.error('loadArticleDetails error', err);
      }
    }

    function createArticleCard(article) {
      const cardId = 'card-' + Math.random().toString(36).substr(2, 9);
      return `
        <div class="col" id="${cardId}">
          <div class="card article-card h-100">
            <a href="#" target="_blank" class="text-decoration-none text-dark">
              <img src="" class="card-img-top article-image d-none" alt="Article Image">
              <div class="card-body">
                <h5 class="card-title">Loading...</h5>
                <p class="card-text article-content">Loading article content...</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="article-source">Loading...</span>
                  <small class="article-date"></small>
                </div>
              </div>
            </a>
          </div>
        </div>`;
    }

    async function loadMoreArticles() {
      if (isLoading) return;
      isLoading = true;
      loadingElement.style.display = 'flex';
      try {
        const targetDate = getDateForOffset(currentDayOffset);
        const articles = await fetchArticlesForDate(targetDate);
        if (articles.length > 0) {
          const articlesHTML = articles.map(createArticleCard).join('');
          articlesGrid.insertAdjacentHTML('beforeend', articlesHTML);
          const newCards = Array.from(articlesGrid.querySelectorAll('.col')).slice(-articles.length);
          newCards.forEach((card, i) => {
            const a = articles[i];
            if (a) loadArticleDetails(a, card);
          });
          currentDayOffset++;
        } else {
          currentDayOffset++;
          hasMore = currentDayOffset < 30;
          if (hasMore) return loadMoreArticles();
          else loadingElement.innerHTML = '<p>No more articles to load</p>';
        }
      } finally {
        isLoading = false;
        if (!hasMore) loadingElement.style.display = 'none';
      }
    }

    function handleScroll() {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 800 && !isLoading && hasMore) {
        loadMoreArticles();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadMoreArticles();
      window.addEventListener('scroll', handleScroll);
    });
  </script>
</body>
</html>
